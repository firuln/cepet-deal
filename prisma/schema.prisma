generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(cuid())
  name              String
  email             String?       @unique
  password          String?
  phone             String?
  avatar            String?
  role              UserRole      @default(BUYER)
  emailVerified     DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  isSuspended       Boolean       @default(false)
  verificationBadge String?
  bio               String?
  location          String?
  username          String?       @unique
  otpAttempts       Int           @default(0)
  otpCode           String?
  otpExpiresAt      DateTime?
  phoneVerified     Boolean       @default(false)
  resetToken        String?
  resetTokenExpiry  DateTime?
  usernameUpdatedAt DateTime?
  articles          Article[]     @relation("ArticleAuthor")
  dealer            Dealer?
  favorites         Favorite[]
  listings          Listing[]
  receivedMessages  Message[]     @relation("ReceivedMessages")
  sentMessages      Message[]     @relation("SentMessages")
  reportsCreated    Report[]      @relation("ReportReporter")
  reportsReviewed   Report[]      @relation("ReportReviewer")
  reviewsGiven      Review[]      @relation("ReviewReviewer")
  reviewsReceived   Review[]      @relation("ReviewSeller")
  viewHistory       ViewHistory[]

  @@index([phone])
}

model DealerApplication {
  id           String    @id @default(cuid())
  name         String
  phone        String
  email        String?
  companyName  String
  address      String
  city         String
  description  String?
  logo         String?
  documents    String[]
  otpCode      String?
  otpExpiresAt DateTime?
  verified     Boolean   @default(false)
  expiresAt    DateTime  @default(dbgenerated("(now() + '01:00:00'::interval)"))
  createdAt    DateTime  @default(now())

  @@index([phone])
  @@index([verified])
}

model Dealer {
  id          String    @id @default(cuid())
  userId      String    @unique
  companyName String
  address     String
  city        String
  description String?
  logo        String?
  documents   String[]
  verified    Boolean   @default(false)
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  logo      String?
  createdAt DateTime  @default(now())
  listings  Listing[]
  models    Model[]
}

model Model {
  id        String    @id @default(cuid())
  name      String
  slug      String
  brandId   String
  createdAt DateTime  @default(now())
  listings  Listing[]
  brand     Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, slug])
}

model Listing {
  id              String        @id @default(cuid())
  userId          String
  brandId         String
  modelId         String
  title           String
  slug            String        @unique
  year            Int
  price           BigInt
  condition       CarCondition
  transmission    Transmission
  fuelType        FuelType
  bodyType        BodyType
  mileage         Int
  color           String
  engineSize      Int?
  description     String
  location        String
  images          String[]
  youtubeUrl      String?
  status          ListingStatus @default(PENDING)
  featured        Boolean       @default(false)
  views           Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  bpkbStatus      String?
  kecelakaan      Boolean?
  kondisiAc       String?
  kondisiBan      String?
  kondisiKaki     String?
  kondisiMesin    String?
  pajakStnk       DateTime?
  pemakaian       String?
  serviceTerakhir String?
  latitude        Float?
  longitude       Float?
  // Car Specifications (NEW)
  enginePower     Int?
  engineTorque    Int?
  cylinders       Int?
  seats           Int?
  doors           Int?
  length          Float?
  width           Float?
  height          Float?
  wheelbase       Float?
  groundClearance Float?
  fuelTank        Float?
  luggageCapacity Float?
  topSpeed        Int?
  acceleration    Float?
  warrantyYears   Int?
  warrantyKm      Int?
  specs           Json?
  features        CarFeature[]
  favorites       Favorite[]
  brand           Brand         @relation(fields: [brandId], references: [id])
  model           Model         @relation(fields: [modelId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages        Message[]
  reviews         Review[]      @relation("ListingReviews")
  viewHistory     ViewHistory[]
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model Message {
  id         String    @id @default(cuid())
  senderId   String
  receiverId String
  listingId  String?
  content    String
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  listing    Listing?  @relation(fields: [listingId], references: [id])
  receiver   User      @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
}

model ViewHistory {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  viewedAt  DateTime @default(now())
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model CarFeature {
  id        String   @id @default(cuid())
  listingId String
  category  String
  name      String
  createdAt DateTime @default(now())
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Banner {
  id        String   @id @default(cuid())
  title     String
  subtitle  String?
  image     String
  link      String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Testimonial {
  id        String   @id @default(cuid())
  name      String
  role      String?
  avatar    String?
  content   String
  rating    Int      @default(5)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model AppSettings {
  id              String   @id @default(cuid())
  aiProvider      String   @default("zhipu") // "zhipu" | "gemini"
  zhipuApiKey     String?  @db.Text
  zhipuModel      String   @default("glm-4-flash")
  geminiApiKey    String?  @db.Text
  geminiModel     String   @default("gemini-1.5-flash-002")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Article {
  id              String          @id @default(cuid())
  title           String
  slug            String          @unique
  content         String
  excerpt         String?
  featuredImage   String?
  category        ArticleCategory
  tags            String[]
  authorId        String
  status          ArticleStatus   @default(DRAFT)
  metaTitle       String?
  metaDescription String?
  views           Int             @default(0)
  publishedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  author          User            @relation("ArticleAuthor", fields: [authorId], references: [id], onDelete: Cascade)
}

model Report {
  id             String         @id @default(cuid())
  reporterId     String
  reportableType ReportableType
  reportableId   String
  reason         ReportReason
  description    String?
  status         ReportStatus   @default(PENDING)
  reviewedBy     String?
  reviewedAt     DateTime?
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  reporter       User           @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer       User?          @relation("ReportReviewer", fields: [reviewedBy], references: [id])
}

model Review {
  id         String       @id @default(cuid())
  listingId  String?
  reviewerId String
  sellerId   String
  rating     Int
  title      String?
  content    String
  response   String?
  status     ReviewStatus @default(PENDING)
  verified   Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  carListing Listing?     @relation("ListingReviews", fields: [listingId], references: [id])
  reviewer   User         @relation("ReviewReviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  seller     User         @relation("ReviewSeller", fields: [sellerId], references: [id], onDelete: Cascade)
}

enum UserRole {
  ADMIN
  DEALER
  SELLER
  BUYER
}

enum CarCondition {
  NEW
  USED
}

enum Transmission {
  MANUAL
  AUTOMATIC
  CVT
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
}

enum BodyType {
  SEDAN
  SUV
  MPV
  HATCHBACK
  COUPE
  PICKUP
  VAN
}

enum ListingStatus {
  PENDING
  ACTIVE
  SOLD
  REJECTED
  EXPIRED
}

enum ArticleCategory {
  NEWS
  REVIEW
  TIPS
  GUIDE
  PROMO
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReportableType {
  LISTING
  USER
  MESSAGE
  ARTICLE
  REVIEW
}

enum ReportReason {
  FRAUD
  SPAM
  INAPPROPRIATE_CONTENT
  FALSE_INFORMATION
  SCAM
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}
